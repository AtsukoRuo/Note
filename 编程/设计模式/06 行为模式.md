# è¡Œä¸ºæ¨¡å¼

è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ä¸»è¦è§£å†³çš„å°±æ˜¯â€œç±»æˆ–å¯¹è±¡ä¹‹é—´çš„äº¤äº’â€é—®é¢˜ã€‚

[TOC]

æ¨¡æ¿æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€èŒè´£é“¾æ¨¡å¼å…·æœ‰ç›¸åŒçš„ä½œç”¨ï¼šå¤ç”¨å’Œæ‰©å±•ã€‚ç‰¹åˆ«æ˜¯æ¡†æ¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒä»¬æ¥æä¾›æ¡†æ¶çš„æ‰©å±•ç‚¹ï¼Œèƒ½å¤Ÿè®©æ¡†æ¶çš„ä½¿ç”¨è€…åœ¨ä¸ä¿®æ”¹æ¡†æ¶æºç çš„æƒ…å†µä¸‹ï¼ŒåŸºäºæ‰©å±•ç‚¹å®šåˆ¶åŒ–æ¡†æ¶çš„åŠŸèƒ½ã€‚

ä¸ºä»€ä¹ˆå¤§é‡æ¡†æ¶ä½¿ç”¨é…ç½®æ–‡ä»¶æ¥æä¾›åŠŸèƒ½ç‰¹æ€§ï¼Ÿé…ç½®æ–‡ä»¶å…·æœ‰ä»¥ä¸‹ä¸¤ä¸ªä¼˜åŠ¿ï¼š

- å°†ä¿®æ”¹çš„é€»è¾‘éƒ½é›†ä¸­åœ¨äº†ä¸€èµ·
- ç¬¦åˆè§£è€¦çš„æ€æƒ³

å¤§é‡ä½¿ç”¨é…ç½®æ–‡ä»¶ä¼šä½¿ä»£ç çš„å†…èšæ€§é™ä½ï¼Œé…ç½®èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚ä¸ºæ­¤ï¼ŒåŸºäºæ³¨è§£çš„æ–¹å¼åœ¨ä¸€äº›åœºåˆä¸‹ä»£æ›¿é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯åŸºäºæ³¨è§£çš„æ–¹å¼å°†ä¿®æ”¹é€»è¾‘åˆ†æ•£åˆ°å„ä¸ªclassæ–‡ä»¶ä¸­ï¼Œå¯ç»´æŠ¤æ€§é™ä½

## è§‚å¯Ÿè€…æ¨¡å¼

### åŸç†åŠåº”ç”¨åœºæ™¯å‰–æ

> Define a one-to-many dependency between objects so that when one object changes state, all its dependents are notified and updated automatically.
>
> åœ¨å¯¹è±¡ä¹‹é—´å®šä¹‰ä¸€ä¸ªä¸€å¯¹å¤šçš„ä¾èµ–ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€æ”¹å˜çš„æ—¶å€™ï¼Œæ‰€æœ‰ä¾èµ–çš„å¯¹è±¡éƒ½ä¼šè‡ªåŠ¨æ”¶åˆ°é€šçŸ¥ã€‚

**è§‚å¯Ÿè€…æ¨¡å¼**ï¼ˆObserver Design Patternï¼‰ä¹Ÿè¢«ç§°ä¸º**å‘å¸ƒè®¢é˜…æ¨¡å¼**ï¼ˆPublish-Subscribe Design Patternï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¢«ä¾èµ–çš„å¯¹è±¡å«ä½œ**è¢«è§‚å¯Ÿè€…**ï¼ˆObservableï¼‰ï¼Œä¾èµ–çš„å¯¹è±¡å«ä½œ**è§‚å¯Ÿè€…**ï¼ˆObserverï¼‰ã€‚å®ƒä»¬è¿˜æœ‰ç€å…¶ä»–ç§°è°“ï¼Œä¾‹å¦‚ï¼ŒSubject-Observerã€Publisher-Subscriberã€Producer-Consumerã€EventEmitter-EventListenerã€Dispatcher-Listenerã€‚

ä¸åŒçš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚ä¸‹ï¼Œè¿™ä¸ªæ¨¡å¼æœ‰æˆªç„¶ä¸åŒçš„å®ç°æ–¹å¼ã€‚ä¾‹å¦‚ï¼ŒåŒæ­¥é˜»å¡ã€å¼‚æ­¥éé˜»å¡ã€è¿›ç¨‹å†…çš„ã€è¿›ç¨‹é—´çš„ã€‚

æˆ‘ä»¬æœ‰æ›´åŠ ä¼˜é›…ã€æ›´åŠ å¸¸ç”¨çš„æ–¹å¼æ¥å®ç°è§‚å¯Ÿè€…æ¨¡å¼ï¼Œé‚£å°±æ˜¯**åŸºäºæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queue**ï¼‰æ¥å®ç°ã€‚å®ƒä¸ä»…ä»…å¯ä»¥å®ç°è¿›ç¨‹é—´çš„è®¢é˜…ï¼Œè€Œä¸”è¿˜æ›´åŠ å½»åº•åœ°è§£è€¦è¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ã€‚

## æ¨¡æ¿æ¨¡å¼

**æ¨¡æ¿æ¨¡å¼ï¼ˆTemplate Method Design Patternï¼‰**

> Define the skeleton of an algorithm in an operation, deferring some steps to subclasses. Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithmâ€™s structure.
>
> æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨ä¸€ä¸ªæ–¹æ³•ä¸­å®šä¹‰ä¸€ä¸ªç®—æ³•éª¨æ¶ï¼Œå¹¶å°†æŸäº›æ­¥éª¤æ¨è¿Ÿåˆ°å­ç±»ä¸­å®ç°ã€‚æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¯ä»¥è®©å­ç±»åœ¨ä¸æ”¹å˜ç®—æ³•æ•´ä½“ç»“æ„çš„æƒ…å†µä¸‹ï¼Œé‡æ–°å®šä¹‰ç®—æ³•ä¸­çš„æŸäº›æ­¥éª¤

è¿™é‡Œçš„ã€Œç®—æ³•ã€ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºã€Œä¸šåŠ¡é€»è¾‘ã€ã€‚



æŠ½è±¡æ–¹æ³•ã€å›è°ƒå‡½æ•°æ˜¯æ¨¡æ¿æ¨¡å¼çš„ä¸€ç§åº”ç”¨ã€‚

A ç±»äº‹å…ˆæ³¨å†ŒæŸä¸ªå›è°ƒå‡½æ•° F åˆ° B ç±»ã€‚åœ¨åˆé€‚çš„æ—¶æœºï¼ŒB ç±»è°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œå¹¶é€šè¿‡å‚æ•°æš´éœ²è‡ªå·±çš„ä¸€äº›çŠ¶æ€ã€‚

Callback æ›´ä¾§é‡è¯­æ³•æœºåˆ¶çš„æè¿°ï¼ŒHook æ›´åŠ ä¾§é‡åº”ç”¨åœºæ™¯çš„æè¿°ã€‚è¿˜æœ‰ä¸€ç§è§‚ç‚¹è®¤ä¸ºæ˜¯è¿™ä¸¤è€…çš„å·®åˆ«åœ¨è°ƒç”¨æ—¶æœºä¸åŒï¼ŒCallback åœ¨æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œè€Œ Hook åœ¨æ–¹æ³•æ‰§è¡Œå‰åè¢«è°ƒç”¨ã€‚



## ç­–ç•¥æ¨¡å¼

> Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it.
>
> å®šä¹‰ä¸€æ—ç®—æ³•ç±»ï¼Œå°†æ¯ä¸ªç®—æ³•åˆ†åˆ«å°è£…èµ·æ¥ï¼Œè®©å®ƒä»¬å¯ä»¥äº’ç›¸æ›¿æ¢ã€‚ç­–ç•¥æ¨¡å¼å¯ä»¥ä½¿ç®—æ³•çš„å˜åŒ–ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œçš„å®¢æˆ·ç«¯ä»£æŒ‡ä½¿ç”¨ç®—æ³•çš„ä»£ç ï¼‰



**ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Design Patternï¼‰**è§£è€¦çš„æ˜¯ç­–ç•¥çš„å®šä¹‰ã€åˆ›å»ºã€ä½¿ç”¨è¿™ä¸‰éƒ¨åˆ†.

### å®šä¹‰

ç­–ç•¥ç±»çš„å®šä¹‰åŒ…å«ä¸€ä¸ªç­–ç•¥æ¥å£å’Œä¸€ç»„å®ç°è¿™ä¸ªæ¥å£çš„ç­–ç•¥ç±»ã€‚å› ä¸ºæ‰€æœ‰çš„ç­–ç•¥ç±»éƒ½å®ç°ç›¸åŒçš„æ¥å£ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯ä»£ç å¯ä»¥åŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹ï¼Œä»è€Œçµæ´»åœ°æ›¿æ¢ä¸åŒçš„ç­–ç•¥ã€‚

~~~java
public interface Strategy {
  void algorithmInterface();
}

public class ConcreteStrategyA implements Strategy {
  @Override
  public void  algorithmInterface() {
    //å…·ä½“çš„ç®—æ³•...
  }
}

public class ConcreteStrategyB implements Strategy {
  @Override
  public void  algorithmInterface() {
    //å…·ä½“çš„ç®—æ³•...
  }
}
~~~

### åˆ›å»º

ç­–ç•¥æ¨¡å¼ä¼šåŒ…å«ä¸€ç»„ç­–ç•¥ï¼Œä¸€èˆ¬åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ç±»å‹ï¼ˆtypeï¼‰æ¥é€‰æ‹©æ€§åœ°åˆ›å»ºç­–ç•¥ç±»ã€‚è¿™æ˜¯å·¥å‚ç±»å…¸å‹çš„ä½¿ç”¨åœºæ™¯ï¼š

~~~java
public class StrategyFactory {
  private static final Map<String, Strategy> strategies = new HashMap<>();

  static {
    strategies.put("A", new ConcreteStrategyA());
    strategies.put("B", new ConcreteStrategyB());
  }

  public static Strategy getStrategy(String type) {
    if (type == null || type.isEmpty()) {
      throw new IllegalArgumentException("type should not be empty.");
    }
    return strategies.get(type);
  }
}

~~~

å¦‚æœç­–ç•¥ç±»æ˜¯æ— çŠ¶æ€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šè¿°ç¼“å­˜ç‰ˆæœ¬çš„å·¥å‚ç±»ã€‚å¦‚æœç­–ç•¥ç±»æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ¥å®ç°ç­–ç•¥å·¥å‚ç±»ã€‚

~~~java
public class StrategyFactory {
  public static Strategy getStrategy(String type) {
    if (type == null || type.isEmpty()) {
      throw new IllegalArgumentException("type should not be empty.");
    }

    if (type.equals("A")) {
      return new ConcreteStrategyA();
    } else if (type.equals("B")) {
      return new ConcreteStrategyB();
    }

    return null;
  }
}

~~~

### ä½¿ç”¨

å®¢æˆ·ç«¯ä¸€èˆ¬åœ¨è¿è¡Œæ—¶ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ã€ç”¨æˆ·è¾“å…¥ç­‰è¿™äº›ä¸ç¡®å®šå› ç´ ï¼Œæ¥åŠ¨æ€ç¡®å®šä½¿ç”¨å“ªç§ç­–ç•¥ã€‚

~~~java
// ç­–ç•¥æ¥å£ï¼šEvictionStrategy
// ç­–ç•¥ç±»ï¼šLruEvictionStrategyã€FifoEvictionStrategyã€LfuEvictionStrategy...
// ç­–ç•¥å·¥å‚ï¼šEvictionStrategyFactory

public class UserCache {
  private Map<String, User> cacheData = new HashMap<>();
  private EvictionStrategy eviction;

  public UserCache(EvictionStrategy eviction) {
    this.eviction = eviction;
  }

  //...
}

// è¿è¡Œæ—¶åŠ¨æ€ç¡®å®šï¼Œæ ¹æ®é…ç½®æ–‡ä»¶çš„é…ç½®å†³å®šä½¿ç”¨å“ªç§ç­–ç•¥
public class Application {
  public static void main(String[] args) throws Exception {
    EvictionStrategy evictionStrategy = null;
    Properties props = new Properties();
    props.load(new FileInputStream("./config.properties"));
    String type = props.getProperty("eviction_type");
    evictionStrategy = EvictionStrategyFactory.getEvictionStrategy(type);	//åŠ¨æ€åœ°é€‰æ‹©ä¸åŒçš„ç­–ç•¥
    UserCache userCache = new UserCache(evictionStrategy);
    //...
  }
}

// éè¿è¡Œæ—¶åŠ¨æ€ç¡®å®šï¼Œåœ¨ä»£ç ä¸­æŒ‡å®šä½¿ç”¨å“ªç§ç­–ç•¥
public class Application {
  public static void main(String[] args) {
    //...
    EvictionStrategy evictionStrategy = new LruEvictionStrategy();
    UserCache userCache = new UserCache(evictionStrategy);
    //...
  }
}
~~~

åœ¨ã€Œéè¿è¡Œæ—¶åŠ¨æ€ç¡®å®šã€çš„åœºæ™¯ä¸­ï¼Œç­–ç•¥æ¨¡å¼å®é™…ä¸Šé€€åŒ–æˆäº†â€œé¢å‘å¯¹è±¡çš„å¤šæ€ç‰¹æ€§â€æˆ–â€œåŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹åŸåˆ™â€ã€‚

### å¦‚ä½•åˆ©ç”¨ç­–ç•¥æ¨¡å¼é¿å…åˆ†æ”¯åˆ¤æ–­ï¼Ÿ

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªå¤§é‡ä½¿ç”¨if-elseçš„ä¾‹å­ï¼š

~~~java
public class OrderService {
  public double discount(Order order) {
    double discount = 0.0;
    OrderType type = order.getType();
    if (type.equals(OrderType.NORMAL)) { // æ™®é€šè®¢å•
      //...çœç•¥æŠ˜æ‰£è®¡ç®—ç®—æ³•ä»£ç 
    } else if (type.equals(OrderType.GROUPON)) { // å›¢è´­è®¢å•
      //...çœç•¥æŠ˜æ‰£è®¡ç®—ç®—æ³•ä»£ç 
    } else if (type.equals(OrderType.PROMOTION)) { // ä¿ƒé”€è®¢å•
      //...çœç•¥æŠ˜æ‰£è®¡ç®—ç®—æ³•ä»£ç 
    }
    return discount;
  }
}
~~~

æ­¤æ—¶æˆ‘ä»¬ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯¹ä¸Šé¢çš„ä»£ç é‡æ„ï¼Œå°†ä¸åŒç±»å‹è®¢å•çš„æ‰“æŠ˜ç­–ç•¥è®¾è®¡æˆç­–ç•¥ç±»ï¼Œå¹¶ç”±å·¥å‚ç±»æ¥è´Ÿè´£åˆ›å»ºç­–ç•¥å¯¹è±¡ã€‚

~~~java
// ç­–ç•¥çš„å®šä¹‰
public interface DiscountStrategy {
  double calDiscount(Order order);
}
// çœç•¥NormalDiscountStrategyã€GrouponDiscountStrategyã€PromotionDiscountStrategyç±»ä»£ç ...

// ç­–ç•¥çš„åˆ›å»º
public class DiscountStrategyFactory {
  private static final Map<OrderType, DiscountStrategy> strategies = new HashMap<>();

  static {
    strategies.put(OrderType.NORMAL, new NormalDiscountStrategy());
    strategies.put(OrderType.GROUPON, new GrouponDiscountStrategy());
    strategies.put(OrderType.PROMOTION, new PromotionDiscountStrategy());
  }

  public static DiscountStrategy getDiscountStrategy(OrderType type) {
    return strategies.get(type);
  }
}

// ç­–ç•¥çš„ä½¿ç”¨
public class OrderService {
  public double discount(Order order) {
    OrderType type = order.getType();
    DiscountStrategy discountStrategy = DiscountStrategyFactory.getDiscountStrategy(type);
    return discountStrategy.calDiscount(order);
  }
}
~~~

ä½†æ˜¯ï¼Œå¦‚æœä¸šåŠ¡åœºæ™¯éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºä¸åŒçš„ç­–ç•¥å¯¹è±¡ï¼ˆæœ‰çŠ¶æ€ï¼‰ï¼Œæˆ‘ä»¬å°±è¦ç”¨å¦å¤–ä¸€ç§å·¥å‚ç±»çš„å®ç°æ–¹å¼äº†ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

~~~java
public class DiscountStrategyFactory {
  public static DiscountStrategy getDiscountStrategy(OrderType type) {
    if (type == null) {
      throw new IllegalArgumentException("Type should not be null.");
    }
    if (type.equals(OrderType.NORMAL)) {
      return new NormalDiscountStrategy();
    } else if (type.equals(OrderType.GROUPON)) {
      return new GrouponDiscountStrategy();
    } else if (type.equals(OrderType.PROMOTION)) {
      return new PromotionDiscountStrategy();
    }
    return null;
  }
}
~~~

### ä¸å·¥å‚æ¨¡å¼çš„åŒºåˆ«

æˆ‘ä»¬å‘ç°ç­–ç•¥æ¨¡å¼ä¸å·¥å‚æ¨¡å¼ååˆ†ç›¸ä¼¼ã€‚å®ƒä»¬çš„åŒºåˆ«åœ¨äºï¼Œç­–ç•¥æ¨¡å¼ä¾§é‡â€œç­–ç•¥â€æˆ–â€œç®—æ³•â€è¿™ä¸ªç‰¹å®šçš„åº”ç”¨åœºæ™¯ï¼Œç”¨æ¥è§£å†³æ ¹æ®è¿è¡Œæ—¶çŠ¶æ€ä»ä¸€ç»„ç­–ç•¥ä¸­é€‰æ‹©ä¸åŒç­–ç•¥çš„é—®é¢˜ï¼Œè€Œå·¥å‚æ¨¡å¼ä¾§é‡å°è£…å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ï¼Œè¿™é‡Œçš„å¯¹è±¡æ²¡æœ‰ä»»ä½•ä¸šåŠ¡åœºæ™¯çš„é™å®šï¼Œå¯ä»¥æ˜¯ç­–ç•¥ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä¸œè¥¿ã€‚ä»è®¾è®¡æ„å›¾ä¸Šæ¥ï¼Œè¿™ä¸¤ä¸ªæ¨¡å¼å®Œå…¨æ˜¯ä¸¤å›äº‹å„¿ã€‚

## èŒè´£é“¾æ¨¡å¼

**èŒè´£é“¾æ¨¡å¼ï¼ˆChain Of Responsibility Design Patternï¼‰**

> Avoid coupling the sender of a request to its receiver by giving more than one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it.
>
> å°†è¯·æ±‚çš„å‘é€å’Œæ¥æ”¶è§£è€¦ï¼Œè®©å¤šä¸ªæ¥æ”¶å¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚å°†è¿™äº›æ¥æ”¶å¯¹è±¡ä¸²æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¿™ä¸ªè¯·æ±‚ï¼Œç›´åˆ°é“¾ä¸Šçš„æŸä¸ªæ¥æ”¶å¯¹è±¡èƒ½å¤Ÿå¤„ç†å®ƒä¸ºæ­¢ã€‚

åœ¨èŒè´£é“¾æ¨¡å¼ä¸­ï¼Œå¤šä¸ªå¤„ç†å™¨ä¾æ¬¡å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ã€‚ä¸€ä¸ªè¯·æ±‚å…ˆç»è¿‡ A å¤„ç†å™¨å¤„ç†ï¼Œç„¶åå†æŠŠè¯·æ±‚ä¼ é€’ç»™ B å¤„ç†å™¨ï¼ŒB å¤„ç†å™¨å¤„ç†å®Œåå†ä¼ é€’ç»™ C å¤„ç†å™¨ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå½¢æˆä¸€ä¸ªé“¾æ¡ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å†³å®šä¸ç»§ç»­ä¼ æ’­ã€‚é“¾æ¡ä¸Šçš„æ¯ä¸ªå¤„ç†å™¨å„è‡ªæ‰¿æ‹…å„è‡ªçš„å¤„ç†èŒè´£ï¼Œæ‰€ä»¥å«ä½œèŒè´£é“¾æ¨¡å¼ã€‚



## çŠ¶æ€æ¨¡å¼

çŠ¶æ€æ¨¡å¼ä¸€èˆ¬ç”¨æ¥å®ç°æœ‰é™çŠ¶æ€æœºï¼Œæ­¤å¤–ï¼Œæœ‰é™çŠ¶æ€æœºè¿˜å¯ä»¥ç”¨åˆ†æ”¯é€»è¾‘æ³•ã€æŸ¥è¡¨æ³•æ¥å®ç°ã€‚

### ä»€ä¹ˆæ˜¯æœ‰é™çŠ¶æ€æœºï¼Ÿ

æœ‰é™çŠ¶æ€æœºï¼ˆFinite State Machineï¼‰ç”±3ä¸ªç»„æˆéƒ¨åˆ†ï¼š

- **çŠ¶æ€ï¼ˆStateï¼‰**
- **äº‹ä»¶ï¼ˆEventï¼‰**ï¼Œä¹Ÿç§°ä¸ºè½¬ç§»æ¡ä»¶ï¼ˆTransition Conditionï¼‰
- **åŠ¨ä½œï¼ˆActionï¼‰**ï¼šåœ¨å‘ç”Ÿè½¬ç§»æ—¶ï¼Œè¦æ‰§è¡Œçš„è¡Œä¸º

### å®ç°ä¸€ï¼šåˆ†æ”¯é€»è¾‘æ³•

![](assets/5aa0310b9b3ea08794cfc2f376c8f96c.jpg)

æˆ‘ä»¬åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼Œå°†è½¬ç§»æ¡ä»¶æŠ½è±¡æ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä¸­å…ˆæ ¹æ®çŠ¶æ€æ‰§è¡Œä¸åŒçš„åŠ¨ä½œï¼Œç„¶åæ›´æ–°çŠ¶æ€ã€‚è°ƒç”¨è€…é€šè¿‡è¿™äº›æŠ½è±¡å‡ºæ¥çš„æ–¹æ³•ï¼Œæ¥é©±åŠ¨æœ‰é™çŠ¶æ€æœºçš„è¿è¡Œã€‚

~~~java
private State currentState;

public void obtainCape() {
    if (currentState.equals(State.SMALL) || currentState.equals(State.SUPER) ) {
        this.currentState = State.CAPE;
        this.score += 200;
    }
}
~~~

è¿™ç§å®ç°æ–¹å¼ï¼Œå……æ–¥ç€å¤§é‡çš„ if-else æˆ–è€… switch-case åˆ†æ”¯åˆ¤æ–­é€»è¾‘ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éƒ½å¾ˆå·®ã€‚

### å®ç°äºŒï¼šæŸ¥è¡¨æ³•

çŠ¶æ€æœºé™¤äº†ç”¨çŠ¶æ€è½¬ç§»å›¾æ¥è¡¨ç¤ºä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨äºŒç»´è¡¨æ¥è¡¨ç¤º

![](assets/4f4ea3787bd955918578181e18173491.jpg)

ç»´æŠ¤ä¸¤å¼ è¡¨ï¼š

~~~java
// çŠ¶æ€è½¬ç§»è¡¨
// è¡Œè¡¨ç¤ºäº†å½“å‰å¤„äºçš„çŠ¶æ€ï¼Œåˆ—è¡¨ç¤ºè§¦å‘çš„è¡Œä¸º
private static final State[][] transitionTable = {
    {SUPER, 	CAPE, 	FIRE, 	/},
    {/, 		CAPE, 	FIRE, 	SMALL},
    {/, 		/, 		/, 		SMALL},
    {/, 		/, 		/. 		SMALL}
};

// åŠ¨ä½œè¡¨
private static final int[][] actionTable = {
    {+100, +200, 	+300, 	+0},
    {+0, 	+200, 	+300, 	-100},
    {+0, 	+0, 	+0, 	-200},
    {+0, 	+0, 	+0, 	-300}
};
~~~

äº‹ä»¶è§¦å‘é€»è¾‘å¦‚ä¸‹ï¼›

~~~java

public void obtainFireFlower() {
    executeEvent(Event.GOT_FIRE);
}

private void executeEvent(Event event) {
    int stateValue = currentState.getValue();		//è·å–å½“å‰çŠ¶æ€å¯¹åº”çš„æšä¸¾å€¼

    int eventValue = event.getValue();			    //è·å–äº‹ä»¶å¯¹åº”çš„æšä¸¾å€¼
    this.currentState = transitionTable[stateValue][eventValue];
    this.score += actionTable[stateValue][eventValue];
}
~~~

ç›¸å¯¹äºåˆ†æ”¯é€»è¾‘çš„å®ç°æ–¹å¼ï¼ŒæŸ¥è¡¨æ³•çš„ä»£ç å®ç°æ›´åŠ æ¸…æ™°ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§æ›´å¥½ã€‚å½“ä¿®æ”¹çŠ¶æ€æœºæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ transitionTable å’Œ actionTable ä¸¤ä¸ªäºŒç»´æ•°ç»„å³å¯ã€‚

å¦‚æœä»¬æŠŠè¿™ä¸¤ä¸ªäºŒç»´æ•°ç»„å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆåªéœ€ç»´æŠ¤é…ç½®æ–‡ä»¶å³å¯ï¼Œä¸ç”¨ä¿®æ”¹ä»£ç ã€‚

### å®ç°ä¸‰ï¼šçŠ¶æ€æ¨¡å¼

å½“äº‹ä»¶è§¦å‘çš„åŠ¨ä½œæ¯”è¾ƒå¤æ‚æ—¶ï¼ˆå†™æ•°æ®åº“ã€å‘é€æ¶ˆæ¯é€šçŸ¥ç­‰ç­‰ï¼‰ï¼ŒæŸ¥è¡¨æ³•å°±ä¸å†é€‚ç”¨äº†ã€‚

çŠ¶æ€æ¨¡å¼é€šè¿‡å°†äº‹ä»¶è§¦å‘çš„çŠ¶æ€è½¬ç§»å’ŒåŠ¨ä½œæ‰§è¡Œï¼Œæ‹†åˆ†åˆ°ä¸åŒçš„çŠ¶æ€ç±»ä¸­ï¼Œæ¥é¿å…åˆ†æ”¯åˆ¤æ–­é€»è¾‘ã€‚

~~~java
public class MarioStateMachine {
  private IMario currentState; // ä¸å†ä½¿ç”¨æšä¸¾æ¥è¡¨ç¤ºçŠ¶æ€

  public MarioStateMachine() {
    this.currentState = new SmallMario(this);
  }

  public void obtainMushRoom() {
    this.currentState.obtainMushRoom();
  }

  public void obtainCape() {
    this.currentState.obtainCape();
  }


  public void setCurrentState(IMario currentState) {
    this.currentState = currentState;
  }
}
~~~



~~~java
// æ‰€æœ‰çŠ¶æ€ç±»çš„æ¥å£
public interface IMario { 
  State getName();
  //ä»¥ä¸‹æ˜¯å®šä¹‰çš„äº‹ä»¶
  void obtainMushRoom();
  void obtainCape();
  void obtainFireFlower();
  void meetMonster();
}

// ä¾èµ–æ³¨å…¥ä¸€ä¸ªçŠ¶æ€æœºï¼Œå½“è§¦å‘äº‹ä»¶æ—¶ï¼Œä¿®æ”¹è¯¥çŠ¶æ€å—ï¼Œå¹¶æ‰§è¡Œä¸€äº›åŠ¨ä½œ
public class SmallMario implements IMario {
  private MarioStateMachine stateMachine;

  public SmallMario(MarioStateMachine stateMachine) {
    this.stateMachine = stateMachine;
  }

  @Override
  public State getName() {
    return State.SMALL;
  }

  @Override
  public void obtainMushRoom() {
    stateMachine.setCurrentState(new SuperMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() + 100);
  }
   // ...
}

public class SuperMario implements IMario {
  private MarioStateMachine stateMachine;

  public SuperMario(MarioStateMachine stateMachine) {
    this.stateMachine = stateMachine;
  }

  @Override
  public State getName() {
    return State.SUPER;
  }

  @Override
  public void obtainMushRoom() {
    // do nothing...
  }

  @Override
  public void obtainCape() {
    stateMachine.setCurrentState(new CapeMario(stateMachine));
    stateMachine.setScore(stateMachine.getScore() + 200);
  }
}
~~~

æˆ‘ä»¬å¯ä»¥æŠŠçŠ¶æ€ç±»è®¾è®¡æˆå•ä¾‹ï¼Œé¿å…çŠ¶æ€åˆ‡æ¢æ—¶åå¤çš„åˆ›å»ºå’Œé”€æ¯ã€‚

~~~java
@Override
public void obtainMushRoom(MarioStateMachine stateMachine) {
    stateMachine.setCurrentState(SuperMario.getInstance());
    stateMachine.setScore(stateMachine.getScore() + 100);
}
~~~



## è¿­ä»£å™¨æ¨¡å¼

**è¿­ä»£å™¨æ¨¡å¼ï¼ˆIterator Design Patternï¼‰**ï¼Œä¹Ÿå«ä½œ**æ¸¸æ ‡æ¨¡å¼ï¼ˆCursor Design Patternï¼‰**ã€‚å®ƒæŠŠéå†æ“ä½œä»é›†åˆç±»ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°è¿­ä»£å™¨ç±»ä¸­ï¼Œè®©ä¸¤è€…çš„èŒè´£æ›´åŠ å•ä¸€ã€‚è¿­ä»£å™¨å’Œé›†åˆç±»çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º

![](assets/cb72b5921681ac13d4fc05237597d2ec.jpg)



## è®¿é—®è€…æ¨¡å¼

è®¿é—®è€…æ¨¡å¼éš¾ä»¥ç†è§£ï¼Œå¾ˆå°‘è¢«åº”ç”¨ï¼Œå› æ­¤äº†è§£å³å¯ã€‚

> Allows for one or more operation to be applied to a set of objects at runtime, decoupling the operations from the object structure.
>
> å…è®¸ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ“ä½œåº”ç”¨åˆ°ä¸€ç»„å¯¹è±¡ä¸Šï¼Œè§£è€¦æ“ä½œå’Œå¯¹è±¡æœ¬èº«ã€‚

å®ƒæœ¬è´¨ä¸Šæ˜¯ç”¨ Single Dispatch æ¥æ¨¡æ‹Ÿ Double Dispatch çš„



ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œè®¾è®¡ä¸€ä¸ªå·¥å…·ï¼Œå°† PDFã€PPTã€Word æ–‡ä»¶ä¸­çš„å†…å®¹æŠ½å–å‡ºæ¥æ”¾åœ¨ txt æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå·¥å…·çš„ç®€æ˜“å®ç°å¦‚ä¸‹ï¼š

~~~java
public abstract class ResourceFile {
  public abstract void extract2txt();
}


public class PPTFile extends ResourceFile {
  @Override
  public void extract2txt() {
    // TODO
  }
}


public class PdfFile extends ResourceFile {
  @Override
  public void extract2txt() {
    // TODO
  }
}
~~~

å¦‚æœå·¥å…·çš„åŠŸèƒ½ä¸åœåœ°æ‰©å±•ï¼Œè¿˜è¦æ±‚æ”¯æŒå‹ç¼©ã€æå–æ–‡ä»¶å…ƒä¿¡æ¯ã€æ„å»ºç´¢å¼•ç­‰ä¸€ç³»åˆ—çš„åŠŸèƒ½ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬ç»§ç»­æŒ‰ç…§ä¸Šé¢çš„å®ç°æ€è·¯ï¼Œå°±ä¼šå­˜åœ¨è¿™æ ·å‡ ä¸ªé—®é¢˜ï¼š

- è¿èƒŒå¼€é—­åŸåˆ™ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„åŠŸèƒ½ï¼Œæ‰€æœ‰ç±»çš„ä»£ç éƒ½è¦ä¿®æ”¹ï¼›
- åŠŸèƒ½å¢å¤šï¼Œæ¯ä¸ªç±»çš„ä»£ç éƒ½ä¸æ–­è†¨èƒ€ï¼Œå¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éƒ½å˜å·®äº†ï¼›
- æŠŠæ‰€æœ‰æ¯”è¾ƒä¸Šå±‚çš„ä¸šåŠ¡é€»è¾‘éƒ½è€¦åˆåˆ° PdfFileã€PPTFileã€WordFile ç±»ä¸­ï¼Œå¯¼è‡´è¿™äº›ç±»çš„èŒè´£ä¸å¤Ÿå•ä¸€ï¼›



é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬æŠŠä¸šåŠ¡æ“ä½œè·Ÿå…·ä½“çš„æ•°æ®ç»“æ„è§£è€¦ï¼Œè®¾è®¡æˆç‹¬ç«‹çš„ç±»ã€‚

~~~java
public abstract class ResourceFile {

}

public class PdfFile extends ResourceFile {

}

//...PPTFileã€WordFileä»£ç çœç•¥...
public class Extractor {
  public void extract2txt(PPTFile pptFile) {
    // TODO
  }

  public void extract2txt(PdfFile pdfFile) {
    // TODO
  }

  public void extract2txt(WordFile wordFile) {
    // TODO
  }
}


public class ToolApplication {
  public static void main(String[] args) {
    Extractor extractor = new Extractor();
    for (ResourceFile resourceFile : resourceFiles) {
      extractor.extract2txt(resourceFile);
    }
  }
}
~~~

æˆ‘ä»¬æŠŠæŠ½å–æ–‡æœ¬å†…å®¹çš„æ“ä½œï¼Œè®¾è®¡æˆäº†ä¸‰ä¸ªé‡è½½å‡½æ•°ã€‚é—æ†¾çš„æ˜¯ï¼Œè¿™ç§å®ç°æ–¹å¼ä¼šç¼–è¯‘æŠ¥é”™ã€‚åœ¨Javaä¸­ï¼Œå‡½æ•°é‡è½½æ˜¯ä¸€ç§é™æ€ç»‘å®šï¼Œåœ¨ç¼–è¯‘æ—¶å¹¶ä¸èƒ½è·å–å¯¹è±¡çš„å®é™…ç±»å‹ã€‚è¿™æ˜¯å› ä¸ºJavaåªæ”¯æŒå•åˆ†æ´¾ã€‚æ‰€è°“çš„**å•åˆ†æ´¾ï¼ˆSingle Dispatchï¼‰**å°±æ˜¯ï¼šæ‰§è¡Œã€Œå“ªä¸ªå¯¹è±¡ã€çš„æ–¹æ³•ï¼Œæ ¹æ®å¯¹è±¡çš„è¿è¡Œæ—¶ç±»å‹æ¥å†³å®šï¼›æ‰§è¡Œå¯¹è±¡çš„ã€Œå“ªä¸ªæ–¹æ³•ã€ï¼Œæ ¹æ®**æ–¹æ³•å‚æ•°çš„ç¼–è¯‘æ—¶ç±»å‹**æ¥å†³å®šã€‚è€Œ**åŒåˆ†æ´¾ï¼ˆDouble Dispatchï¼‰**çš„å«ä¹‰ï¼šæ‰§è¡Œã€Œå“ªä¸ªå¯¹è±¡ã€çš„æ–¹æ³•ï¼Œæ ¹æ®å¯¹è±¡çš„è¿è¡Œæ—¶ç±»å‹æ¥å†³å®šï¼›æ‰§è¡Œå¯¹è±¡çš„ã€Œå“ªä¸ªæ–¹æ³•ã€ï¼Œæ ¹æ®**æ–¹æ³•å‚æ•°çš„è¿è¡Œæ—¶ç±»å‹**æ¥å†³å®šã€‚Single Dispatch å’Œ Double Dispatch è·Ÿå¤šæ€å’Œå‡½æ•°é‡è½½ç›´æ¥ç›¸å…³ã€‚å½“å‰ä¸»æµçš„é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼ˆæ¯”å¦‚ï¼ŒJavaã€C++ã€C#ï¼‰éƒ½åªæ”¯æŒ Single Dispatchã€‚

**å¦‚æœJavaæ”¯æŒåŒåˆ†æ´¾æ¨¡å¼ï¼Œé‚£ä¹ˆå°±ä¸ç”¨å®ç°æ¥ä¸‹æ¥çš„è®¿é—®è€…æ¨¡å¼äº†ã€‚**

~~~java
public abstract class ResourceFile {
  abstract public void accept(Extractor extractor);
}

public class PdfFile extends ResourceFile {
  @Override
  public void accept(Extractor extractor) {
    extractor.extract2txt(this);
  }

  //...
}

//...PPTFileã€WordFileè·ŸPdfFileç±»ä¼¼ï¼Œè¿™é‡Œå°±çœç•¥äº†...
//...Extractorä»£ç ä¸å˜...

public class ToolApplication {
  public static void main(String[] args) {
    Extractor extractor = new Extractor();
    for (ResourceFile resourceFile : resourceFiles) {
      resourceFile.accept(extractor);
    }
  }
}
~~~

åœ¨æ‰§è¡Œ`resourceFile.accept(extractor);`æ—¶ï¼Œç¨‹åºæ ¹æ®å¤šæ€ç‰¹æ€§ï¼Œä¼šè°ƒç”¨å®é™…ç±»å‹çš„`accept()`æ–¹æ³•ã€‚ä»¥`PdfFile`çš„`accept`æ–¹æ³•ä¸ºä¾‹ï¼Œæ‰§è¡Œ`extractor.extract2txt(this)`æ—¶ï¼Œ`this`çš„ç±»å‹åœ¨ç¼–è¯‘æœŸæ—¶å°±ç¡®å®šä¸‹æ¥ï¼Œä¹‹åå°±ä¼šè°ƒç”¨`extractor`çš„`extract2txt(PdfFile pdfFile)`è¿™ä¸ªé‡è½½å‡½æ•°ã€‚æ˜¯ä¸æ˜¯å¾ˆæœ‰æŠ€å·§æ€§ï¼Œä½†è¿˜æ²¡ç»“æŸğŸ˜¥ã€‚

ä¸Šé¢ä»£ç è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå¦‚æœè¦æ·»åŠ ä¸€ä¸ªæ–°çš„ä¸šåŠ¡ï¼Œè¿˜æ˜¯éœ€è¦ä¿®æ”¹ `ResourceFile` æ¥å£ä¸­çš„æ–¹æ³•ï¼Œä»¥åŠå„è‡ª XXXFile å®ç°è¿™äº›æ–¹æ³•ï¼Œæ‰©å±•é€»è¾‘æ¯”è¾ƒåˆ†æ•£ï¼Œè¿åå¼€é—­åŸåˆ™ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æŠ½è±¡å‡ºæ¥ä¸€ä¸ª Visitor æ¥å£ï¼Œå®ƒåŒ…å«ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«å¤„ç†ä¸‰ç§ä¸åŒç±»å‹çš„èµ„æºæ–‡ä»¶ã€‚

~~~java
public abstract class ResourceFile {
  abstract public void accept(Visitor vistor);
}


public class PdfFile extends ResourceFile {
  @Override
  public void accept(Visitor visitor) {
    visitor.visit(this);
  }
}


public interface Visitor {
  void visit(PdfFile pdfFile);
  void visit(PPTFile pdfFile);
  void visit(WordFile pdfFile);
}

public class Extractor implements Visitor {
  @Override
  public void visit(PPTFile pptFile) {
    // TODO
  }

  @Override
  public void visit(PdfFile pdfFile) {
    // TODO
  }

  @Override
  public void visit(WordFile wordFile) {
    // TODO
  }
}

public class Compressor implements Visitor {
  @Override
  public void visit(PPTFile pptFile) {
    // TODO
  }

  @Override
  public void visit(PdfFile pdfFile) {
    // TODO
  }

  @Override
  public void visit(WordFile wordFile) {
    // TODO
  }

}

public class ToolApplication {
  public static void main(String[] args) {
    Extractor extractor = new Extractor();
    for (ResourceFile resourceFile : resourceFiles) {
      resourceFile.accept(extractor);		//å¯¹è±¡æ¥å—è¿™ä¸ªæ“ä½œ
    }

    Compressor compressor = new Compressor();
    for(ResourceFile resourceFile : resourceFiles) {
      resourceFile.accept(compressor);
    }
  }

}

~~~

è¿™æ ·ï¼Œå½“æˆ‘ä»¬æ–°æ·»åŠ ä¸€ä¸ªä¸šåŠ¡åŠŸèƒ½çš„æ—¶å€™ï¼Œèµ„æºæ–‡ä»¶ç±»ä¸éœ€è¦åšä»»ä½•ä¿®æ”¹ã€‚

![](assets/c42c636c5384da5bd5343618305db865.jpg)

ä¸€èˆ¬æ¥è¯´ï¼Œè®¿é—®è€…æ¨¡å¼é’ˆå¯¹çš„æ˜¯ä¸€ç»„ç±»å‹ä¸åŒçš„å¯¹è±¡ï¼ˆPdfFileã€PPTFileã€WordFileï¼‰ã€‚æˆ‘ä»¬éœ€è¦å¯¹è¿™ç»„å¯¹è±¡è¿›è¡Œä¸€ç³»åˆ—ä¸ç›¸å…³çš„ä¸šåŠ¡æ“ä½œï¼ˆæŠ½å–æ–‡æœ¬ã€å‹ç¼©ç­‰ï¼‰ï¼Œä½†ä¸ºäº†é¿å…ä¸æ–­æ·»åŠ åŠŸèƒ½å¯¼è‡´ç±»ï¼ˆPdfFileã€PPTFileã€WordFileï¼‰ä¸æ–­è†¨èƒ€ï¼ŒèŒè´£è¶Šæ¥è¶Šä¸å•ä¸€ï¼Œä»¥åŠé¿å…é¢‘ç¹åœ°æ·»åŠ åŠŸèƒ½å¯¼è‡´çš„é¢‘ç¹ä»£ç ä¿®æ”¹ï¼Œæˆ‘ä»¬ä½¿ç”¨è®¿é—®è€…æ¨¡å¼ï¼Œå°†å¯¹è±¡ä¸æ“ä½œè§£è€¦ï¼Œå°†è¿™äº›ä¸šåŠ¡æ“ä½œæŠ½ç¦»å‡ºæ¥ï¼Œå®šä¹‰åœ¨ç‹¬ç«‹ç»†åˆ†çš„è®¿é—®è€…ç±»ï¼ˆExtractorã€Compressorï¼‰ä¸­ã€‚



å®é™…ä¸Šï¼Œä¸Šè¿°çš„ä¾‹å­æˆ‘ä»¬è¿˜æœ‰å…¶ä»–çš„å®ç°æ–¹æ³•ï¼Œä¾‹å¦‚ç­–ç•¥æ¨¡å¼ï¼ˆä¸€å¼€å§‹æˆ‘å°±æƒ³åˆ°è¿™ç§æ–¹æ³•äº† ğŸ¤­ï¼‰ã€‚
~~~Java
public abstract class ResourceFile {
  public abstract ResourceFileType getType();
}

public class PdfFile extends ResourceFile {
  @Override
  public ResourceFileType getType() {
    return ResourceFileType.PDF;
  }
}


//å°† extract é€»è¾‘æŠ½ç¦»åˆ° Extractor æ¥å£ä¸­
public interface Extractor {
  void extract2txt(ResourceFile resourceFile);
}

public class PdfExtractor implements Extractor {
  @Override
  public void extract2txt(ResourceFile resourceFile) {
    //...
  }
}



public class ExtractorFactory {
  private static final Map<ResourceFileType, Extractor> extractors = new HashMap<>();
  static {
    extractors.put(ResourceFileType.PDF, new PdfExtractor());
    extractors.put(ResourceFileType.PPT, new PPTExtractor());
    extractors.put(ResourceFileType.WORD, new WordExtractor());
  }

  public static Extractor getExtractor(ResourceFileType type) {
    return extractors.get(type);
  }
}


public class ToolApplication {
  public static void main(String[] args) {
    for (ResourceFile resourceFile : resourceFiles) {
      //æ ¹æ®èµ„æºçš„ç±»å‹ï¼Œåˆ›å»ºå¯¹åº”çš„æ‰§è¡Œé€»è¾‘
      Extractor extractor = ExtractorFactory.getExtractor(resourceFile.getType());
      //æ‰§è¡Œ
      extractor.extract2txt(resourceFile);
    }
  }
}
~~~

ä»£ç ç»“æ„ç›¸æ¯”è®¿é—®è€…æ¨¡å¼æ›´åŠ ç®€æ´ã€æ˜“æ‡‚ã€‚å”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ï¼Œå½“åŠŸèƒ½å¢å¤šæ—¶ï¼Œæ‰€è¦åˆ›å»ºçš„ç±»è¦æ¯”è®¿é—®è€…æ¨¡å¼å¤šã€‚

## å¤‡å¿˜å½•æ¨¡å¼

**å¤‡å¿˜å½•æ¨¡å¼ï¼ˆMemento Design Patternï¼‰**ï¼Œåˆç§°ä¸º**å¿«ç…§ï¼ˆSnapshotï¼‰**æ¨¡å¼ã€‚

>Captures and externalizes an objectâ€™s internal state so that it can be restored later, all without violating encapsulation.
>
>åœ¨ä¸è¿èƒŒå°è£…åŸåˆ™çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿ä¹‹åæ¢å¤å¯¹è±¡ä¸ºå…ˆå‰çš„çŠ¶æ€ã€‚

æˆ‘ä»¬è¦å›ç­”ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- ä¸ºä»€ä¹ˆå­˜å‚¨å’Œæ¢å¤å‰¯æœ¬ä¼šè¿èƒŒå°è£…åŸåˆ™ï¼Ÿ
- å¤‡å¿˜å½•æ¨¡å¼æ˜¯å¦‚ä½•åšåˆ°ä¸è¿èƒŒå°è£…åŸåˆ™çš„ï¼Ÿ

ç°åœ¨æˆ‘ä»¬è¦å®ç°è¿™ä¸ªéœ€æ±‚ï¼šç¼–å†™ä¸€ä¸ªå°ç¨‹åºï¼Œå¯ä»¥æ¥æ”¶å‘½ä»¤è¡Œçš„è¾“å…¥ã€‚ç”¨æˆ·è¾“å…¥æ–‡æœ¬æ—¶ï¼Œç¨‹åºå°†å…¶è¿½åŠ å­˜å‚¨åœ¨å†…å­˜æ–‡æœ¬ä¸­ï¼›ç”¨æˆ·è¾“å…¥â€œ:listâ€ï¼Œç¨‹åºåœ¨å‘½ä»¤è¡Œä¸­è¾“å‡ºå†…å­˜æ–‡æœ¬çš„å†…å®¹ï¼›ç”¨æˆ·è¾“å…¥â€œ:undoâ€ï¼Œç¨‹åºä¼šæ’¤é”€ä¸Šä¸€æ¬¡è¾“å…¥çš„æ–‡æœ¬ï¼Œä¹Ÿå°±æ˜¯ä»å†…å­˜æ–‡æœ¬ä¸­å°†ä¸Šæ¬¡è¾“å…¥çš„æ–‡æœ¬åˆ é™¤æ‰ã€‚

~~~
>hello
>:list
hello
>world
>:list
helloworld
>:undo
>:list
hello
~~~

ä¸€ä¸ªç®€å•çš„å®ç°å¦‚ä¸‹ï¼š

~~~java

public class InputText {
  private StringBuilder text = new StringBuilder();

  public String getText() {
    return text.toString();
  }

  public void append(String input) {
    text.append(input);
  }

  public void setText(String text) {
    this.text.replace(0, this.text.length(), text);
  }
}

// é€šè¿‡æ ˆæ¥ä¿å­˜å†å²è¾“å…¥
public class SnapshotHolder {
  private Stack<InputText> snapshots = new Stack<>();

  public InputText popSnapshot() {
    return snapshots.pop();
  }

  public void pushSnapshot(InputText inputText) {
      InputText deepClonedInputText = new InputText();
      deepClonedInputText.setText(inputText.getText());		//æ·±å¤åˆ¶
      snapshots.push(deepClonedInputText);
  }
}

public class ApplicationMain {
  public static void main(String[] args) {
    InputText inputText = new InputText();		//è¡¨ç¤ºå†…å­˜æ–‡æœ¬
    SnapshotHolder snapshotsHolder = new SnapshotHolder();
    Scanner scanner = new Scanner(System.in);
    while (scanner.hasNext()) {
      String input = scanner.next();
      if (input.equals(":list")) {
        //æ‰“å°å†…å­˜æ–‡æœ¬
        System.out.println(inputText.getText());		
      } else if (input.equals(":undo")) {
        //ä»æ ˆä¸­å¼¹å‡ºä¸€ä¸ªå†…å­˜æ–‡æœ¬
        InputText snapshot = snapshotsHolder.popSnapshot();
        // ä»å†…å­˜æ–‡æœ¬ä¸­å°†ä¸Šæ¬¡è¾“å…¥çš„æ–‡æœ¬åˆ é™¤æ‰
        inputText.setText(snapshot.getText());
      } else {
        //å°†è¿™ä¸ªå†…å­˜æ–‡æœ¬å‹å…¥æ ˆä¸­
        //æ ˆæ˜¯æ”¯æŒæ·±å¤åˆ¶çš„
        snapshotsHolder.pushSnapshot(inputText);
        inputText.append(input);
      }
    }
  }
}

~~~

ä¸Šé¢çš„ä»£ç æœ‰ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š

- è¿èƒŒäº†å°è£…åŸåˆ™ã€‚ä¸ºäº†èƒ½ç”¨å¿«ç…§æ¢å¤InputTextå¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨InputTextç±»ä¸­å®šä¹‰äº†setText()å‡½æ•°ï¼Œè¯­ä¹‰å¾ˆå®½æ³›ã€‚è¿™å¯èƒ½ä¼šè¢«å…¶ä»–ä¸šåŠ¡ä½¿ç”¨ã€‚
- ç†è®ºä¸Šè®²ï¼Œå¿«ç…§æœ¬èº«æ˜¯ä¸å¯å˜çš„ã€‚ä½†æ˜¯â€œå¿«ç…§â€œè¿™ä¸ªä¸šåŠ¡æ¨¡å‹å¤ç”¨äº† InputText ç±»çš„å®šä¹‰ï¼Œè€Œ InputText ç±»æœ¬èº«æœ‰ä¿®æ”¹å†…éƒ¨çŠ¶æ€çš„å‡½æ•°ã€‚

å¯¹æ­¤ï¼Œæˆ‘ä»¬åšä¸€ä¸‹ä¿®æ”¹ï¼š

~~~java
public class InputText {
  private StringBuilder text = new StringBuilder();

  public String getText() {
    return text.toString();
  }

  public void append(String input) {
    text.append(input);
  }

  public Snapshot createSnapshot() {
    return new Snapshot(text.toString());
  }

  //åœ¨InputTextç±»ä¸­ï¼Œæˆ‘ä»¬æŠŠsetText()æ–¹æ³•é‡å‘½åä¸ºrestoreSnapshot()æ–¹æ³•ï¼Œç”¨æ„æ›´åŠ æ˜ç¡®ï¼Œåªç”¨æ¥æ¢å¤å¯¹è±¡ã€‚
  public void restoreSnapshot(Snapshot snapshot) {
    this.text.replace(0, this.text.length(), snapshot.getText());
  }
}

// å®šä¹‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»ï¼ˆSnapshotç±»ï¼‰æ¥è¡¨ç¤ºå¿«ç…§ï¼Œè€Œä¸æ˜¯å¤ç”¨ InputText ç±»ã€‚
public class Snapshot {
  private String text;

  public Snapshot(String text) {
    this.text = text;
  }

  public String getText() {
    return this.text;
  }
}

public class SnapshotHolder {
  private Stack<Snapshot> snapshots = new Stack<>();

  public Snapshot popSnapshot() {
    return snapshots.pop();
  }

  public void pushSnapshot(Snapshot snapshot) {
    snapshots.push(snapshot);
  }
}

public class ApplicationMain {
  public static void main(String[] args) {
    InputText inputText = new InputText();
    SnapshotHolder snapshotsHolder = new SnapshotHolder();
    Scanner scanner = new Scanner(System.in);
    while (scanner.hasNext()) {
      String input = scanner.next();
      if (input.equals(":list")) {
        System.out.println(inputText.toString());
      } else if (input.equals(":undo")) {
        Snapshot snapshot = snapshotsHolder.popSnapshot();
        inputText.restoreSnapshot(snapshot);
      } else {
        snapshotsHolder.pushSnapshot(inputText.createSnapshot());
        inputText.append(input);
      }
    }
  }
}

~~~

ä¸Šé¢çš„ä»£ç å®ç°å°±æ˜¯å…¸å‹çš„å¤‡å¿˜å½•æ¨¡å¼çš„ä»£ç å®ç°ã€‚æ ¸å¿ƒæ€è·¯å°±æ˜¯å°†å¿«ç…§å•ç‹¬æŠ½è±¡å‡ºä¸€ä¸ªç±»ï¼Œå°†å®é™…æ“ä½œå¯¹è±¡ä¸å¯¹è±¡è¿‡å»çš„çŠ¶æ€è¿›è¡Œè§£è€¦ã€‚

æ€»ç»“ï¼š

- å°†å¯¹è±¡çš„æŸä¸€æ—¶åˆ»çš„çŠ¶æ€æŠ½è±¡ä¸ºä¸€ä¸ªçŠ¶æ€ç±»ï¼ˆå¿«ç…§ï¼‰
- ä½¿ç”¨æ ˆæ¥å®ç°å¤‡å¿˜å½•çš„åŠŸèƒ½
- æ ˆæŒæœ‰çŠ¶æ€ç±»ï¼Œè€Œä¸æ˜¯å¯¹è±¡è¢«æœ¬èº«



ä¸‹é¢æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¿«ç…§çš„æ€§èƒ½é—®é¢˜ã€‚å¦‚æœå¿«ç…§å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆå¤‡ä»½å’Œæ¢å¤çš„è€—æ—¶ä¼šæ¯”è¾ƒé•¿ã€‚ä¸åŒçš„åº”ç”¨åœºæ™¯ä¸‹æœ‰ä¸åŒçš„è§£å†³æ–¹æ³•ã€‚

- **å…¨é‡å¤‡ä»½**
- **å¢é‡å¤‡ä»½**

æ‹¿ä¸Šä¸€ä¸ªä¾‹å­æ¥è¯´ï¼Œå®ƒä»…ä»…æ”¯æŒé¡ºåºæ’¤é”€ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å¿«ç…§ä¸­è®°å½•æ–‡æœ¬é•¿åº¦ï¼Œç„¶åç»“åˆ InputText ç±»å¯¹è±¡å­˜å‚¨çš„æ–‡æœ¬æ¥åšæ’¤é”€æ“ä½œï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¢é‡å¤‡ä»½ã€‚

## å‘½ä»¤æ¨¡å¼

**å‘½ä»¤æ¨¡å¼ï¼ˆCommand Design Patternï¼‰**

>The command pattern encapsulates a request as an object, thereby letting us parameterize other objects with different requests, queue or log requests, and support undoable operations.
>
>å‘½ä»¤æ¨¡å¼å°†è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¯·æ±‚å‚æ•°åŒ–å…¶ä»–å¯¹è±¡ï¼ˆå°†ä¸åŒè¯·æ±‚ä¾èµ–æ³¨å…¥åˆ°å…¶ä»–å¯¹è±¡ï¼‰ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ”¯æŒè¯·æ±‚ï¼ˆå‘½ä»¤ï¼‰çš„æ’é˜Ÿæ‰§è¡Œã€è®°å½•æ—¥å¿—ã€æ’¤é”€ç­‰ï¼ˆé™„åŠ æ§åˆ¶ï¼‰åŠŸèƒ½ã€‚

**æ ¸å¿ƒæ€æƒ³å°±æ˜¯æ“ä½œæ•°æ®åŒ–ï¼Œæ–¹ä¾¿å¯¹æ§åˆ¶æ“ä½œçš„æ‰§è¡Œ**ã€‚æ¯”å¦‚ï¼Œå¼‚æ­¥ã€å»¶è¿Ÿã€æ’é˜Ÿæ‰§è¡Œå‘½ä»¤ã€æ’¤é”€é‡åšå‘½ä»¤ã€å­˜å‚¨å‘½ä»¤ç­‰ç­‰ã€‚

C/C++è¯­è¨€æ”¯æŒå‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»¥å¾ˆæ–¹ä¾¿åœ°å°†å‡½æ•°è¡¨ç¤ºä¸ºæ•°æ®ã€‚ä½†æ˜¯åƒ Java è¿™ç§è¯­è¨€ï¼Œåªèƒ½å°†å‡½æ•°å°è£…æˆå¯¹è±¡ï¼Œå®ç°å¯¹å‡½æ•°çš„æ•°æ®åŒ–ã€‚ç°ä»£ Java å¯ä»¥å°†å‡½æ•°è¡¨è¾¾æˆ Lambda æ¥æ–¹ä¾¿åšåˆ°è¿™ä¸€ç‚¹ã€‚Goã€Dart è¯­è¨€å‡½æ•°æ˜¯ä¸€ç­‰æˆå‘˜ï¼Œå¯ä»¥å®šä¹‰å‡½æ•°ç±»å‹çš„å˜é‡ã€‚

## è§£é‡Šå™¨æ¨¡å¼

**è§£é‡Šå™¨æ¨¡å¼ï¼ˆInterpreter Design Patternï¼‰**

> Interpreter pattern is used to defines a grammatical representation for a language and provides an interpreter to deal with this grammar.
>
> è§£é‡Šå™¨æ¨¡å¼ä¸ºæŸä¸ªè¯­è¨€å®šä¹‰å®ƒçš„è¯­æ³•ï¼ˆæˆ–è€…å«æ–‡æ³•ï¼‰è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ç”¨æ¥å¤„ç†è¿™ä¸ªè¯­æ³•ã€‚

è¿™é‡Œçš„ã€Œè¯­è¨€ã€æ˜¯æŒ‡ä¿¡æ¯çš„è½½ä½“ï¼Œè€Œã€Œè¯­æ³•ã€æ˜¯ç”¨æ¥è§£è¯»è¯­è¨€çš„ä¸€å¥—è§„åˆ™ã€‚è€Œã€Œè§£é‡Šå™¨ã€æ˜¯æ ¹æ®è¯­æ³•ï¼Œè·å–è¯­è¨€æ‰€è¦è¡¨è¾¾çš„ä¿¡æ¯ã€‚

## ä¸­ä»‹æ¨¡å¼

**ä¸­ä»‹æ¨¡å¼ï¼ˆMediator Design Patternï¼‰**

> Mediator pattern defines a separate (mediator) object that encapsulates the interaction between a set of objects and the objects delegate their interaction to a mediator object instead of interacting with each other directly.
>
> ä¸­ä»‹æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªå•ç‹¬çš„ï¼ˆä¸­ä»‹ï¼‰å¯¹è±¡ï¼Œæ¥å°è£…ä¸€ç»„å¯¹è±¡ä¹‹é—´çš„äº¤äº’ã€‚å°†è¿™ç»„å¯¹è±¡ä¹‹é—´çš„äº¤äº’å§”æ´¾ç»™ä¸ä¸­ä»‹å¯¹è±¡äº¤äº’ï¼Œæ¥é¿å…å¯¹è±¡ä¹‹é—´çš„ç›´æ¥äº¤äº’ã€‚

ä¸­ä»‹æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³ï¼Œ**æ˜¯é€šè¿‡å¼•å…¥ä¸­é—´å±‚**ï¼Œå°†ä¸€ç»„å¯¹è±¡ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼ˆæˆ–è€…è¯´ä¾èµ–å…³ç³»ï¼‰ä»å¤šå¯¹å¤šï¼ˆç½‘çŠ¶å…³ç³»ï¼‰è½¬æ¢ä¸ºä¸€å¯¹å¤šï¼ˆæ˜ŸçŠ¶å…³ç³»ï¼‰ã€‚

![](assets/4376d541bf17a029f37aa76009ef3a9f.jpg)



æˆ‘ä»¬ä»¥UIæ§ä»¶ä¸ºä¾‹å­ï¼Œæ¥è®²è§£ä¸­ä»‹æ¨¡å¼ã€‚

~~~java
public class UIControl {
  private static final String LOGIN_BTN_ID = "login_btn";
  private static final String REG_BTN_ID = "reg_btn";
  private static final String USERNAME_INPUT_ID = "username_input";
  private static final String PASSWORD_INPUT_ID = "pswd_input";
  private static final String REPEATED_PASSWORD_INPUT_ID = "repeated_pswd_input";
  private static final String HINT_TEXT_ID = "hint_text";
  private static final String SELECTION_ID = "selection";

  public static void main(String[] args) {
    Button loginButton = (Button)findViewById(LOGIN_BTN_ID);
    Button regButton = (Button)findViewById(REG_BTN_ID);
    Input usernameInput = (Input)findViewById(USERNAME_INPUT_ID);
    Input passwordInput = (Input)findViewById(PASSWORD_INPUT_ID);
    Input repeatedPswdInput = (Input)findViewById(REPEATED_PASSWORD_INPUT_ID);
    Text hintText = (Text)findViewById(HINT_TEXT_ID);
    Selection selection = (Selection)findViewById(SELECTION_ID);
	
    // ä¸‹é¢å°±æ˜¯é—®é¢˜æ‰€åœ¨äº†
    loginButton.setOnClickListener(new OnClickListener() {
      @Override
      public void onClick(View v) {
        String username = usernameInput.text();
        String password = passwordInput.text();
        //æ ¡éªŒæ•°æ®...
        //åšä¸šåŠ¡å¤„ç†...
      }
    });

    regButton.setOnClickListener(new OnClickListener() {
      @Override
      public void onClick(View v) {
      //è·å–usernameInputã€passwordInputã€repeatedPswdInputæ•°æ®...
      //æ ¡éªŒæ•°æ®...
      //åšä¸šåŠ¡å¤„ç†...
      }
    });

    //...çœç•¥selectionä¸‹æ‹‰é€‰æ‹©æ¡†ç›¸å…³ä»£ç ....
  }
}
~~~

åœ¨è¿™ç§å®ç°æ–¹å¼ä¸­ï¼Œæ§ä»¶å’Œæ§ä»¶ä¹‹é—´äº’ç›¸æ“ä½œã€äº’ç›¸ä¾èµ–ã€‚æˆ‘ä»¬å†æŒ‰ç…§ä¸­ä»‹æ¨¡å¼ï¼Œå°†ä¸Šé¢çš„ä»£ç é‡æ–°å®ç°ä¸€ä¸‹ã€‚

~~~java
public interface Mediator {
  void handleEvent(Component component, String event);
}

public class LandingPageDialog implements Mediator {
  private Button loginButton;
  private Button regButton;
  private Selection selection;
  private Input usernameInput;
  private Input passwordInput;
  private Input repeatedPswdInput;
  private Text hintText;

  @Override
  public void handleEvent(Component component, String event) {
    //è¿™é‡Œå¯ä»¥ä½¿ç”¨å·¥å‚ç±»æ¥ä»£æ›¿
    if (component.equals(loginButton)) {
      String username = usernameInput.text();
      String password = passwordInput.text();
      //æ ¡éªŒæ•°æ®...
      //åšä¸šåŠ¡å¤„ç†...
    } else if (component.equals(regButton)) {
      //è·å–usernameInputã€passwordInputã€repeatedPswdInputæ•°æ®...
      //æ ¡éªŒæ•°æ®...
      //åšä¸šåŠ¡å¤„ç†...
    } else if (component.equals(selection)) {
      String selectedItem = selection.select();
      if (selectedItem.equals("login")) {
        usernameInput.show();
        passwordInput.show();
        repeatedPswdInput.hide();
        hintText.hide();
        //...çœç•¥å…¶ä»–ä»£ç 
      } else if (selectedItem.equals("register")) {
        //....
      }
    }
  }
}

public class UIControl {
  private static final String LOGIN_BTN_ID = "login_btn";
  private static final String REG_BTN_ID = "reg_btn";
  private static final String USERNAME_INPUT_ID = "username_input";
  private static final String PASSWORD_INPUT_ID = "pswd_input";
  private static final String REPEATED_PASSWORD_INPUT_ID = "repeated_pswd_input";
  private static final String HINT_TEXT_ID = "hint_text";
  private static final String SELECTION_ID = "selection";

  public static void main(String[] args) {
    Button loginButton = (Button)findViewById(LOGIN_BTN_ID);
    Button regButton = (Button)findViewById(REG_BTN_ID);
    Input usernameInput = (Input)findViewById(USERNAME_INPUT_ID);
    Input passwordInput = (Input)findViewById(PASSWORD_INPUT_ID);
    Input repeatedPswdInput = (Input)findViewById(REPEATED_PASSWORD_INPUT_ID);
    Text hintText = (Text)findViewById(HINT_TEXT_ID);
    Selection selection = (Selection)findViewById(SELECTION_ID);

    //ä¸­ä»‹ç±»
    Mediator dialog = new LandingPageDialog();
    dialog.setLoginButton(loginButton);
    dialog.setRegButton(regButton);
    dialog.setUsernameInput(usernameInput);
    dialog.setPasswordInput(passwordInput);
    dialog.setRepeatedPswdInput(repeatedPswdInput);
    dialog.setHintText(hintText);
    dialog.setSelection(selection);

    loginButton.setOnClickListener(new OnClickListener() {
      @Override
      public void onClick(View v) {
        //å°†å®ç°é€»è¾‘è½¬ç§»åˆ°ä¸­ä»‹ç±»ä¸­
        dialog.handleEvent(loginButton, "click");
      }
    });

    regButton.setOnClickListener(new OnClickListener() {
      @Override
      public void onClick(View v) {
        dialog.handleEvent(regButton, "click");
      }
    });

    //....
  }
}

~~~

åœ¨ä½¿ç”¨ä¸­ä»‹æ¨¡å¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æ ¹æ®å®é™…çš„æƒ…å†µï¼Œå¹³è¡¡å¯¹è±¡ä¹‹é—´äº¤äº’çš„å¤æ‚åº¦å’Œä¸­ä»‹ç±»æœ¬èº«çš„å¤æ‚åº¦ã€‚é¿å…ä¸­ä»‹ç±»å˜æˆå¤§è€Œå¤æ‚çš„**â€œä¸Šå¸ç±»â€ï¼ˆGod Classï¼‰**ã€‚

ä¸­ä»‹æ¨¡å¼ä¸è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ç›¸ä¼¼çš„ï¼Œä½†è§‚å¯Ÿè€…æ¨¡å¼å¾€å¾€å¤„ç†ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè€Œä¸­ä»‹æ¨¡å¼å¯ä»¥å¤„ç†å¤šå¯¹å¤šçš„å…³ç³»ã€‚



