# 配置

在微服务体系中，手动更新每一个微服务实例的配置几乎无从谈起。因此，我们需要引入集中化的配置中心，可以统一配置各个微服务实例。这里我们介绍 Spring Cloud Config 配置中心。在 Config 中，有以下两个部分：

- 服务端（集中化配置中心）：从某个地方（例如 Github ）读取对应的配置文件
- 客户端：具体的微服务实例，通过服务端来获取自己的配置文件



Config 服务端的 Maven 依赖：

~~~xml
<!-- Config 服务端依赖 -->
<dependency>
   <groupId>org.springframework.cloud</groupId>
   <artifactId>spring-cloud-config-server</artifactId>
</dependency>
~~~

服务端的配置文件：

~~~yaml
spring:
  cloud:
    config:
      # Config服务端配置
      server:
        # 使用Git，从Git仓库中读取配置文件
        git:
          # GitHub 的 URI，以这个 URI 作为配置文件的根目录
          uri: https://github.com/ykzhen2019/chapter10
          # 如果使用的是私有仓库，则需要填写用户密码
          # GitHub用户名
          # username: your-username
          # GitHub密码
          # password: your-password
          # 默认的Git分支，默认值为“master”
          # default-label: master
          # 查找路径，可以配置Git仓库的文件路径，
          # 使用逗号分隔可配置多个路径
          # search-paths: /config
  application:
    # 微服务名称
    name: config-center
# 配置端口
server:
  port: 4001
~~~



通过注解 `@EnableConfigServer` 驱动该服务为 Config 的服务端

~~~java
@SpringBootApplication(scanBasePackages = "com.spring.cloud.cfgserver")
// 驱动该微服务为Config服务端
@EnableConfigServer
public class CfgServerApplication {

   public static void main(String[] args) {
      SpringApplication.run(CfgServerApplication.class, args);
   }
}
~~~



客户端的 Maven 依赖：

~~~xml
<dependency>
   <groupId>org.springframework.cloud</groupId>
   <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
~~~

然后在模块 cfg-client 中的 resources 文件夹下添加文件 bootstrap.yml。它先于 application.yml 文件进行加载

~~~yaml
spring:
  application:
    # 微服务名称
    name: config-client
  cloud:
    # Config 客户端配置
    config:
      # 连接的 服务端 URI
      uri: http://localhost:4001
      # 是否支持快速失败
      fail-fast: false
      # 使用的分支，如果缺省就会采用服务端的spring.cloud.config.server.git.default-label配置项
      # label: master
  profiles:
    # 配置版本号
    active:
    - v1
~~~

Config 客户端从服务端那里获取 `{spring.application.name}-{spring.profiles.active}.yml` 配置文件





服务端也可以从本地读取配置文件：

~~~yaml
spring:
  cloud:
    config:
      # Config服务端配置
      server:
        # 本地文件
        native:
          # classpath指向类路径，/configs代表目录
          search-locations: classpath:/configs  # ①
  application:
    # 微服务名称
    name: config-center
  profiles:
    # 注意，这个配置项一定要配置，
    # 否则Config服务端会因默认使用 Git 而报错
    active: native # ②
server:
  # 启动端口
  port: 4001
~~~



## 安全

某些配置项是敏感信息，需要加密保存。在Config中，支持用 JCE（Java Cryptography Extension）规则进行加密配置。

在 Config 中，会默认给出以下4个关于 JCE 的端点

- `/encrypt/status`：GET请求，查看当前JCE状态
- `/key`：GET请求，加密或解密密钥
- `/encrypt`：POST请求，加密请求体
- `/decrypt`：POST请求，解密请求体

在  bootstrap.yml 文件中做如下配置：

~~~yaml
encrypt:
  # 这是一个对称加密的密钥
  key: chapter10
~~~

我们**手动**用该密钥进行加密，并将密文放在配置文件中：

~~~java
# 服务端口
server:
  port: 3001

# 当前版本信息 
version:
  message: '{cipher}b2f55adafb35d6dfd812a15365ff4c3c34fea63a180634b47f387c2bd93f0c54994f0f49d915b5daf5af266a559e7a15'  # ①
~~~

Config 会根据 {encrypt.key} 以及密文的前缀（这里是 {cipher} ）来做解密的

## 高可用

我们通过 Eureka 来实现 Config 的高可用。Config 客户端通过服务发现指定配置中心

~~~yaml
spring:
  application:
    # 微服务名称
    name: config-client
  cloud:
    # Config服务端配置
    config:
      # ...
      # 服务发现配置
      discovery:
        # 是否启用服务发现寻找Config服务端
        enabled: true
        # Config服务端serviceId
        serviceId: config-center
~~~



